# ğŸ› ï¸ ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆ ì‹¤ì „ ì„¸íŒ… & ìë™í™” ê°€ì´ë“œ

> Supabase MCP Server + Next.js í™˜ê²½ì—ì„œ publicì´ ì•„ë‹Œ ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆ(your_schema)ë¡œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©ì ê´€ë¦¬í•˜ëŠ” ì‹¤ì „ ë°©ë²•ì„ ì •ë¦¬í•©ë‹ˆë‹¤.

---

## 1. í•µì‹¬ SQL ì˜ˆì‹œ ìœ„ì¹˜

- `db/custom-schema-sample.sql`
  - ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆ ìƒì„±, profiles í…Œì´ë¸”, íŠ¸ë¦¬ê±°, RLS, grade ë“± **ì‹¤ì „ SaaS í•„ìˆ˜ SQL** ëª¨ë‘ í¬í•¨

---

## 2. ì ìš© ë°©ë²• (Step by Step)

1. **your_schema**ë¥¼ ì›í•˜ëŠ” ìŠ¤í‚¤ë§ˆëª…(ì˜ˆ: `company_a`, `tenant1` ë“±)ìœ¼ë¡œ ë³€ê²½
2. í•„ìš”ì— ë”°ë¼ ì»¬ëŸ¼/ì •ì±…/ENUM ìˆ˜ì •
3. Supabase ëŒ€ì‹œë³´ë“œ â†’ **SQL Editor**ì—ì„œ ì „ì²´ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° â†’ ì‹¤í–‰
   - ë˜ëŠ” supabase CLIë¡œ ì‹¤í–‰
4. (ì„ íƒ) íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ íƒ€ì…ì€ ì§ì ‘ ì •ì˜ (public ìŠ¤í‚¤ë§ˆë§Œ ìë™ ìƒì„± ì§€ì›)

---

## 3. ì£¼ìš” ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **RLS(í–‰ ìˆ˜ì¤€ ë³´ì•ˆ) í™œì„±í™”** ë° ì •ì±… ì ìš©
- [ ] **íŠ¸ë¦¬ê±°/í•¨ìˆ˜**: íšŒì›ê°€ì… ì‹œ profiles row ìë™ ìƒì„±
- [ ] **grade ì»¬ëŸ¼**: ê¶Œí•œ/ë“±ê¸‰ ê´€ë¦¬
- [ ] **updated_at íŠ¸ë¦¬ê±°**: ìë™ íƒ€ì„ìŠ¤íƒ¬í”„ ê°±ì‹ 
- [ ] **auth.usersì™€ 1:1 ë§¤í•‘** (id uuid PRIMARY KEY REFERENCES auth.users(id))

---

## 4. ì‹¤ìˆ˜ ë°©ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì´ˆë³´ì í•„ë…)

> ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆë¥¼ ì“¸ ë•Œ ì´ˆë³´ìê°€ ê°€ì¥ ë§ì´ ì‹¤ìˆ˜í•˜ëŠ” í¬ì¸íŠ¸ì™€ ì‹¤ì „ íŒì„ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

### 1) `.schema('your_schema')`ë¥¼ ë°˜ë“œì‹œ ë¶™ì´ê¸°
- Supabase JS í´ë¼ì´ì–¸íŠ¸ì—ì„œ **from()ë§Œ ì“°ë©´ public ìŠ¤í‚¤ë§ˆ**ì— ì ‘ê·¼í•©ë‹ˆë‹¤.
- ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆë¥¼ ì“¸ ë•ŒëŠ” í•­ìƒ `.schema('your_schema').from('í…Œì´ë¸”')`ë¡œ ì‹œì‘í•˜ì„¸ìš”.

### 2) RLS(í–‰ ìˆ˜ì¤€ ë³´ì•ˆ) ì •ì±…ì€ ìŠ¤í‚¤ë§ˆë³„ë¡œ ë”°ë¡œ ì„¤ì •
- ìŠ¤í‚¤ë§ˆë§ˆë‹¤ RLSë¥¼ ë°˜ë“œì‹œ í™œì„±í™”í•˜ê³ , ì •ì±…ì„ ë³„ë„ë¡œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
- RLSê°€ ì—†ìœ¼ë©´ ë°ì´í„°ê°€ ë…¸ì¶œë˜ê±°ë‚˜, ì•„ì˜ˆ ì ‘ê·¼ì´ ì•ˆ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3) íƒ€ì… ìë™ ìƒì„±ì€ publicë§Œ ì§€ì›
- Supabaseì˜ íƒ€ì… ìë™ ìƒì„±(`supabase gen types typescript ...`)ì€ **publicë§Œ ì§€ì›**. ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆëŠ” ì§ì ‘ íƒ€ì… ì •ì˜ í•„ìš” (ì˜ˆì‹œ ì œê³µ ì˜ˆì •)

### 4) REST APIëŠ” publicë§Œ ë…¸ì¶œ
- Supabase REST API(ìë™ ìƒì„± API)ëŠ” public ìŠ¤í‚¤ë§ˆë§Œ ë…¸ì¶œë©ë‹ˆë‹¤.
- ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆëŠ” JS í´ë¼ì´ì–¸íŠ¸, SQL, Edge Function ë“±ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### 5) Foreign Key/ì°¸ì¡°ëŠ” ìŠ¤í‚¤ë§ˆëª…ê¹Œì§€ ëª…ì‹œ
- ì˜ˆ: `REFERENCES auth.users(id)` ì²˜ëŸ¼ ìŠ¤í‚¤ë§ˆëª…ì„ ê¼­ ì¨ì•¼ í•©ë‹ˆë‹¤.

### 6) ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘ schema() ëª…ì‹œ
- ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ëª¨ë‘ `.schema('your_schema')`ë¥¼ ëª…ì‹œí•´ì•¼ í•©ë‹ˆë‹¤.
- ì•ˆ ê·¸ëŸ¬ë©´ public ìŠ¤í‚¤ë§ˆë¡œ ì ‘ê·¼í•˜ê²Œ ë©ë‹ˆë‹¤.

### 7) ë§ˆì´ê·¸ë ˆì´ì…˜/SQL ì‹¤í–‰ ì‹œ ìŠ¤í‚¤ë§ˆëª… ëª…ì‹œ
- SQL Editor, migration ë„êµ¬ì—ì„œ í•­ìƒ `your_schema.í…Œì´ë¸”`ë¡œ ëª…ì‹œí•˜ì„¸ìš”.

### 8) ê¶Œí•œ/ì •ì±… ë¶„ë¦¬
- ì—¬ëŸ¬ ìŠ¤í‚¤ë§ˆë¥¼ ì“¸ ë•ŒëŠ” ìŠ¤í‚¤ë§ˆë³„ë¡œ ì •ì±…/ê¶Œí•œì„ ë¶„ë¦¬í•´ì„œ ê´€ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
- (ì˜ˆ: í…Œë„ŒíŠ¸ë³„ ë°ì´í„° ê²©ë¦¬)

### 9) ìŠ¤í‚¤ë§ˆëª…ì„ ìƒìˆ˜/í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ë©´ ì‹¤ìˆ˜ ë°©ì§€
- ì½”ë“œì—ì„œ ìŠ¤í‚¤ë§ˆëª…ì„ í•˜ë“œì½”ë”©í•˜ì§€ ë§ê³ , ìƒìˆ˜/í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•˜ë©´ ìœ ì§€ë³´ìˆ˜ì— ìœ ë¦¬í•©ë‹ˆë‹¤.

---

## 5. ê³ ê¸‰ ì‹¤ì „ íŒ: ìŠ¤í‚¤ë§ˆ ê°ì²´ ê´€ë¦¬

### 1) í•¨ìˆ˜/íŠ¸ë¦¬ê±°/ì‹œí€€ìŠ¤ë„ ìŠ¤í‚¤ë§ˆì— ê·€ì†
- CREATE FUNCTION, CREATE TRIGGER, CREATE SEQUENCE ë“±ì€ ëª¨ë‘ **ìŠ¤í‚¤ë§ˆë³„ë¡œ ìƒì„±**ë¨
- í•­ìƒ `your_schema.function_name`ì²˜ëŸ¼ **í•¨ìˆ˜ëª… ì•ì— ìŠ¤í‚¤ë§ˆëª…**ì„ ë¶™ì—¬ì•¼ í•¨
- íŠ¸ë¦¬ê±° í•¨ìˆ˜ê°€ publicì— ìˆìœ¼ë©´ your_schema í…Œì´ë¸”ì—ì„œ í˜¸ì¶œ ë¶ˆê°€
- ì˜ˆì‹œ:
  - `CREATE FUNCTION your_schema.handle_new_user() ...`
  - `CREATE TRIGGER ... EXECUTE FUNCTION your_schema.handle_new_user();`

### 2) View(ë·°)Â·Materialized Viewë„ ìŠ¤í‚¤ë§ˆë³„ë¡œ ê´€ë¦¬
- CREATE VIEW your_schema.my_view AS ... ì²˜ëŸ¼ **ìŠ¤í‚¤ë§ˆëª… ëª…ì‹œ**
- ë·°ì—ì„œ ë‹¤ë¥¸ ìŠ¤í‚¤ë§ˆì˜ í…Œì´ë¸”ì„ ì¡°ì¸í•  ë•ŒëŠ” ë°˜ë“œì‹œ `ìŠ¤í‚¤ë§ˆëª….í…Œì´ë¸”ëª…`ìœ¼ë¡œ ì ‘ê·¼
- ì˜ˆì‹œ:
  - `CREATE VIEW your_schema.active_users AS SELECT * FROM your_schema.profiles WHERE grade = 'admin';`
  - `SELECT * FROM your_schema.active_users JOIN auth.users ON ...`

> ì‹¤ì „ íŒ: ëª¨ë“  ê°ì²´(í•¨ìˆ˜, íŠ¸ë¦¬ê±°, ì‹œí€€ìŠ¤, ë·° ë“±)ëŠ” ìŠ¤í‚¤ë§ˆë³„ë¡œ ê´€ë¦¬ëœë‹¤ëŠ” ì ì„ í•­ìƒ ê¸°ì–µí•˜ì„¸ìš”!

---

## 6. ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)

### Q. publicì´ ì•„ë‹Œ ìŠ¤í‚¤ë§ˆì—ì„œ íƒ€ì… ìë™ ìƒì„±ì€?
- A. Supabase íƒ€ì… ìë™ ìƒì„±(`supabase gen types typescript ...`)ì€ **publicë§Œ ì§€ì›**. ì»¤ìŠ¤í…€ ìŠ¤í‚¤ë§ˆëŠ” ì§ì ‘ íƒ€ì… ì •ì˜ í•„ìš” (ì˜ˆì‹œ ì œê³µ ì˜ˆì •)

### Q. profiles ëŒ€ì‹  usersë¡œ ì¨ë„ ë˜ë‚˜?
- A. ê°€ëŠ¥í•˜ì§€ë§Œ, Supabase ê³µì‹ ì˜ˆì œ/ì»¤ë®¤ë‹ˆí‹°ëŠ” **profiles ë¶„ë¦¬**ë¥¼ ê¶Œì¥ (auth.usersì™€ 1:1 ë§¤í•‘)

### Q. grade(ë“±ê¸‰/ê¶Œí•œ) ì»¬ëŸ¼ì€ ì–´ë–»ê²Œ ì“°ë‚˜?
- A. profiles í…Œì´ë¸”ì— grade ì»¬ëŸ¼ ì¶”ê°€ + RLS ì •ì±…ì—ì„œ í™œìš© (ì˜ˆ: adminë§Œ ì „ì²´ ì¡°íšŒ/ìˆ˜ì • ê°€ëŠ¥)

### Q. íŠ¸ë¦¬ê±°/í•¨ìˆ˜ëŠ” ê¼­ ì¨ì•¼ í•˜ë‚˜?
- A. íšŒì›ê°€ì… ì‹œ ìë™ row ìƒì„±, updated_at ìë™ ê°±ì‹  ë“± ì‹¤ì „ SaaSì—ì„œëŠ” í•„ìˆ˜ì— ê°€ê¹ê²Œ ì‚¬ìš©

---

## 7. ì‹¤ì „ ì˜ˆì‹œ ì½”ë“œ/ì¿¼ë¦¬

> **ì•„ë˜ SQLì„ ë³µì‚¬í•´ì„œ your_schemaë§Œ ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë°”ê¿”ì„œ ì‹¤í–‰í•˜ì„¸ìš”!**

```
-- (ìì„¸í•œ ì˜ˆì‹œëŠ” db/custom-schema-best-practices.sql ì°¸ê³ )

-- 1. ìŠ¤í‚¤ë§ˆ ìƒì„±
CREATE SCHEMA IF NOT EXISTS your_schema;

-- 2. profiles í…Œì´ë¸” ìƒì„±
CREATE TABLE IF NOT EXISTS your_schema.profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email text,
  name text,
  avatar_url text,
  grade text DEFAULT 'user',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

-- 3. íšŒì›ê°€ì… ì‹œ ìë™ row ìƒì„± íŠ¸ë¦¬ê±°/í•¨ìˆ˜
CREATE OR REPLACE FUNCTION your_schema.handle_new_user() ...
CREATE TRIGGER on_auth_user_created ...

-- 4. RLS ì •ì±… (ë³¸ì¸ë§Œ/ê´€ë¦¬ì ì „ì²´)
ALTER TABLE your_schema.profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY ...;

-- 5. updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±°
CREATE OR REPLACE FUNCTION your_schema.update_timestamp() ...
CREATE TRIGGER set_timestamp_on_profiles ...

-- 6. (ê³ ê¸‰) í•¨ìˆ˜/íŠ¸ë¦¬ê±°/ë·°/ì‹œí€€ìŠ¤ë„ ë°˜ë“œì‹œ your_schema.ì´ë¦„ ìœ¼ë¡œ ìƒì„±/ì°¸ì¡°
-- ì˜ˆì‹œ: CREATE FUNCTION your_schema.handle_new_user() ...
-- ì˜ˆì‹œ: CREATE VIEW your_schema.active_users AS SELECT * FROM your_schema.profiles WHERE grade = 'admin';
```

---

## 8. ì°¸ê³ /íŒ
- **ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë°˜ë“œì‹œ RLS ì •ì±…ì„ ê¼¼ê¼¼íˆ ê²€í† **
- **ENUM íƒ€ì…, ì¶”ê°€ ì»¬ëŸ¼, ì •ì±… ë“±ì€ ì„œë¹„ìŠ¤ì— ë§ê²Œ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ**
- **ë¬¸ì„œ/SQL ì˜ˆì‹œëŠ” ì–¸ì œë“  ë³µì‚¬í•´ì„œ ì¬ì‚¬ìš© ê°€ëŠ¥** 